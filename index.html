<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>一次方程式トレーニング</title>
<style>
body {
  font-family: "Segoe UI", "Hiragino Sans", sans-serif;
  background: linear-gradient(135deg, #e3f2fd, #f1f8e9);
  text-align: center;
  margin: 0;
  padding: 0;
}

h1 {
  font-size: 26px;
  margin-top: 25px;
  color: #1565c0;
}

.container {
  background: white;
  border-radius: 16px;
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
  display: inline-block;
  padding: 30px 40px;
  margin-top: 30px;
  max-width: 600px;
  width: 90%;
}

label {
  font-size: 16px;
  margin: 8px;
  display: inline-block;
}

input[type="number"] {
  font-size: 16px;
  padding: 5px 8px;
  border: 1px solid #bbb;
  border-radius: 6px;
  width: 90px;
  text-align: center;
}

button {
  font-size: 16px;
  padding: 8px 16px;
  margin: 5px;
  border: none;
  border-radius: 8px;
  cursor: pointer;
  transition: 0.2s;
}

button:hover {
  transform: translateY(-2px);
}

button:active {
  transform: translateY(1px);
}

button:nth-of-type(1) {
  background: #42a5f5;
  color: white;
}
button:nth-of-type(1):hover {
  background: #1e88e5;
}

#question {
  font-size: 24px;
  font-weight: bold;
  margin-top: 25px;
  color: #333;
}

#step {
  font-size: 22px;
  color: #444;
  margin-top: 15px;
  display: none;
  background: #f9f9f9;
  border-radius: 8px;
  padding: 10px;
  border: 1px solid #ddd;
}

#answerBox {
  font-size: 18px;
  margin-top: 20px;
}

#userAnswer {
  font-size: 18px;
  padding: 6px;
  width: 120px;
  border: 1px solid #bbb;
  border-radius: 6px;
  text-align: center;
}

#stats {
  margin-top: 15px;
  font-size: 18px;
  color: #1565c0;
}

#timer {
  font-size: 18px;
  color: #555;
  margin-top: 10px;
}

#feedback {
  font-size: 42px;
  font-weight: bold;
  color: white;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: none;
  justify-content: center;
  align-items: center;
  z-index: 999;
  animation: fadeIn 0.3s ease;
}

.correct {
  background: rgba(56, 142, 60, 0.9); /* green */
}

.wrong {
  background: rgba(211, 47, 47, 0.9); /* red */
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}
</style>
</head>
<body>
<h1>一次方程式トレーニング</h1>

<div class="container">
  <div>
    <label>問題の難しさ(標準:10)：<input type="number" id="diff" value="10"></label><br>
    <label>答えの難しさ(標準:10)：<input type="number" id="a_diff" value="10"></label><br>
    <button onclick="startGame()">スタート</button>
  </div>

  <div id="timer">経過時間: 0秒</div>
  <div id="stats">正解数: 0 / 0　(正答率: 0%)</div>

  <div id="question"></div>
  <div id="step"></div>

  <div id="answerBox">
    <input type="number" id="userAnswer" placeholder="x = ?" 
           onkeydown="if(event.key==='Enter'){checkAnswer();}">
    <button onclick="checkAnswer()">判定</button>
    <button onclick="showStep()">途中式</button>
  </div>
</div>

<div id="feedback"></div>

<script>
let diff = 1000, a_diff = 1000;
let a, b, c, d, xAns;
let correct = 0, total = 0;
let startTime, timerInterval;

function startGame() {
  diff = parseInt(document.getElementById('diff').value);
  a_diff = parseInt(document.getElementById('a_diff').value);
  correct = 0; total = 0;
  updateStats();
  document.getElementById('step').style.display = "none";
  startTime = Date.now();
  clearInterval(timerInterval);
  timerInterval = setInterval(updateTimer, 1000);
  newQuestion();
}

function updateTimer() {
  const elapsed = Math.floor((Date.now() - startTime) / 1000);
  document.getElementById('timer').textContent = `経過時間: ${elapsed}秒`;
}

function newQuestion() {
  document.getElementById('step').style.display = "none";
  document.getElementById('userAnswer').value = "";
  document.getElementById('feedback').style.display = "none";

  while (true) {
    let x = Math.floor(Math.random() * (2*a_diff+1)) - a_diff;
    a = Math.floor(Math.random() * (2*diff+1)) - diff;
    b = Math.floor(Math.random() * (2*diff+1)) - diff;
    c = Math.floor(Math.random() * (2*diff+1)) - diff;
    if (a - c === 0) continue; // xが消える式だけ除外

    d = (a - c) * x + b;
    let left = `${a}x${formatTerm(b)}`;
    let right = `${c}x${formatTerm(d)}`;
    document.getElementById('question').textContent = `${left} = ${right}`;
    xAns = x;
    break;
  }
}

function formatTerm(n) {
  if (n === 0) return "";
  return (n > 0 ? "+" + n : n);
}

function simplifyStep(a, b, c, d) {
  let step1 = `${a}x${formatTerm(b)} = ${c}x${formatTerm(d)}`;
  let step2 = `${a}x - ${c}x = ${d} - (${b})`;
  let leftVal = a - c;
  let rightVal = d - b;
  let step3 = `${formatX(leftVal)} = ${rightVal}`;
  return `${step1}<br>${step2}<br>${step3}`;
}

function formatX(v) {
  if (v === 1) return "x";
  if (v === -1) return "-x";
  if (v === 0) return "";
  return `${v}x`;
}

function showStep() {
  const step = simplifyStep(a, b, c, d);
  document.getElementById('step').innerHTML = step;
  document.getElementById('step').style.display = "block";
}

function checkAnswer() {
  const ans = parseFloat(document.getElementById('userAnswer').value);
  if (isNaN(ans)) return;

  const feedback = document.getElementById('feedback');
  feedback.className = ""; // reset

  if (Math.abs(ans - xAns) < 1e-6) {
    feedback.textContent = "正解！";
    feedback.classList.add("correct");
    correct++;
    total++;
    showFeedback(0.3);
  } else {
    feedback.innerHTML = `不正解<br><span style="font-size:28px;">(答え: <b>${xAns}</b>)</span>`;
    feedback.classList.add("wrong");
    total++;
    showFeedback(0.6);
  }
  updateStats();
}

function updateStats() {
  const accuracy = total === 0 ? 0 : Math.round((correct / total) * 100);
  document.getElementById('stats').textContent =
    `正解数: ${correct} / ${total}　(正答率: ${accuracy}%)`;
}

function showFeedback(delay) {
  const fb = document.getElementById('feedback');
  fb.style.display = "flex";
  setTimeout(() => {
    fb.style.display = "none";
    newQuestion();
  }, delay * 1000);
}
</script>
</body>
</html>
